## 实验记录
前期实验：单个点，sr=4000, step=2048, fft=512, mels=128
尝试拟合stiffness matrix: （非对角对称矩阵）
        [[[[force_scale, non_diag_scale, 0],
        [non_diag_scale, force_scale, 0],
        [0, 0, force_scale]]]]
初步实验中 non_diag_scale = force_scale.
使用网络：3层linear+relu，3x16,16x16,16x3，使用L1loss

遇到问题：拟合出来的波形总是频率不准（频谱几乎和ground truth无相交），且振幅逐渐增大，频谱能量集中在频谱后半段。如下图所示波形与频谱：
![](notes/images/exp4.png)
![](notes/images/exp5.png)

怎么回事？
单步运行观察神经网络的输出发现，神经网络倾向于在输入从正到负变化时使得输出大幅度变化！
但是输出是受力的比例！这个东西不应该随着某一维度位移的变化发生大幅度变化！
除此之外，这样拟合真的可以降低loss(虽然只能降一点点)！这说明loss设计不合理！
修改方案：
1. 减小输入正则化范围在零点附近的波动
2. 暂时假设正向和反向的振动是对称的，用其输入神经网络相同的值
3. 减小mel数，使得两个频谱有更大范围相交，从而方便优化 
4. 改成LSDloss （疑似本场景中L1loss并不合理）

进一步实验发现，波形振幅逐渐增大并不是必然出现的，但是总是拟合不了想要的频谱，频率总是无法被优化，有时也会有波形振幅随时间减小的情况出现，loss使用L1或LSD情况类似。

观察Ground truth频谱可以发现：这个实验setting下振动分裂成两个频率，由最后一维度单独振动产生的频率，与由前两维度互相影响产生的振动频率，如图
![](notes/images/exp3.png)
我们现在想：能不能先试一下用同一个神经网络拟合两个分立的、彼此无关的不同频率的振动？
现在我们试图拟合频率为100，200的两个分立的振动的合成，神经网络的输出被scale到频率为50-400.
结果是：还是不行！神经网络总是倾向于输出两个差不多的频率的振动，反映在频谱上就是中间的一坨，并不会明显的把这两个振动给分开，分别拟合两个振动！
如图：(下图是待拟合的波形频谱)
![](notes/images/exp1.png)
（下图是拟合输出波形的频谱）
![](notes/images/exp2.png)

继续加强条件：把神经网络输出的第一个维度scale到75-150，第二个维度到150-300，强行分开可行吗？
使用LSDloss, eps=1e-3, 这样终于能训得出来了！loss从0.3降到了0.01！L1与L2 loss均训不出来。
但是这限制太强了！一旦减弱限制，例如如果不把输出的两个维度强行分开（例如两个维度的输出都在75-300的范围）那样就训不出来！用lsd, L1或者L2都训不出来！

分析：可能从神经网络某一时刻的输出（某一维度输入位移和输出弹性力的比例）到频谱中某一点的强度，这一过程太过implicit，需要以某种方式对输出进行约束；除此之外，当多个维度互相影响时，将输出设为某一个维度输入位移和弹性力的比值，并不一定合理。例如某一个维度位移几乎为0，但是其他维度的位移给了这一维度一定的弹性力。


现在的想法：用一个一阶线性的矩阵来近似stiff matvec，用这个东西模拟K，来对标准振动方程来奇异值分解，然后取奇异值分解频率低于某一阈值的若干模态（防止步进模拟爆炸），用这一部分对应位移作为神经网络的输入！
先用simple.py做实验（因为stiffness matrix已经表示出来了），奇异值分解后拿掉前6个奇异值，对剩下的奇异值取低频部分拿出来！

loss: 1.考虑damping 2. 考虑模态的频率有没有对上
学长的意见：没有模态的地方视作damping非常大，只计算每个mel filter的damping

230406：把lobpcg挪过来改一下，让它允许输入一个函数，而不是一个stiffness matrix


针对线性的例子：首先提取线性模态，不加noise，暂时不用非线性，并且筛选并去掉damping过大的模态
同时考虑一维聚类等方法（考虑有多个频谱）（单个物体有多个敲击声音，一个可能有问题，用多个相似的求平均等方式，来减小误差等），之后找一个非线性的例子，先用线性拟合，然后固定参数，训练非线性部分



现在我们尝试用comsol来作为高阶特征值的ground truth!
首先右键几何，创建导入子节点，导入对应stl模型；
右键网格，创建自由四面体网格；
在固体力学中创建线弹性材料节点，指定密度杨氏模量泊松比；在固体力学下拉栏中选择离散化，指定有限元阶数（拉格朗日单元）
在研究中指定所需特征频率数，并去除前6个结果，点击计算即可
可在结果-振型处看到特征频率

## 23-05-01
现在的任务：
1. 整合当前fem代码到最新的代码里面，查最新代码问题并且修复
2. 完成第一部分代码：从模型中通过lobpcg得到U_hat, 这个模块存在一个可学习参数θ（材料模型等），输入随机位移q，输出约化节点力U_hat f_θ(U_hat q)，这个东西作为神经网络的输入，输出下一时刻的频率前缀和（它与从真实声音中学到的前缀和做loss来训练神经网络）
其中可以预训练从真实声音中学前缀和的模块，然后再训前面的！


23-05-05
把GT的模态直接给oscillator，然后参数固定下来，看模型能不能学会
预训练久一点！至少3w步，测真实物体
直接拟合真实物体
ln -s /data/xcx/ ./data

0510
暂时不做非线性了，强调可微框架，画饼有什么用
1.拟合材料参数，目前是杨氏模量泊松比
2.之后还可以做damping的拟合，比如多项式啥啥；
3.预测敲击位置，目前拟合的是振幅，要消除传播带来的影响；然后求表面所有点的匹配度
4.简单的几何拟合，我们先把模型随机压缩一个比例，可以是单个维度的缩放（写三个自由度，从只有大小开始，然后单个维度缩放），预测这个比例（比如说拍照片，计算机能看出来形状但是看不出来大小，可以用这个预测！）简单的做一些，说有希望拟合几何，不用很深入！

样例22使用新loss重跑，对于gt模态过多的例子，降低其采样率！至少做4个材料不一样的例子！ceramic的选形状不一样的例子！
对每个样例，单独对log频谱做RMSE作为填表上的loss，不回传
对于shape的实验：消融实验，使用合成声音，手动设定参数固定osc，用该固定osc产生的声音作为gt！
之后再使用真实声音，需要我们的方法和baseline的对比！

0524 
1. 把第一个实验的音频重新处理，Ceramic改damping，后两个物体的声音频率整体增大 √
2. 用damping curve更新第二个物体的数据和频谱，然后增长第一个物体的音频，使用48000Hz采样率，和视频声音一样 √
3. 在论文和视频素材补上1scale的实验 √
4. 将实验3的声音也改成一秒
5. 把2迁移到4的声音和频谱补上

after
0616
主要攻克非线性情况
先考虑fem教程中的经典非线性情况
除了频谱，还有什么可以描述声音的特征？
想办法近似？否则显存会炸RN
RNN？进去一个seq，出来一个seq，可以attention？


0629
关于非线性的梯度问题
如果要优化youngs/poisson, 之前的方法是首先获得无梯度的eigenvalue（事实上如果要让它本身有梯度，就需要特征值分解全程可微，which is extremely costly!）
然后，用stiff func（而不是身stiffness matrix, 因为它没梯度！）作用一遍，stiff func中的youngs/poisson的梯度就会被eigenvalue获得！

现在，为了做到这一点，在step模拟中，我们有两个思路：
1. 保持上述算法，但是stiff func在梯度流程中过几千遍而不是一遍
2. 先让stiff matrix获得梯度，然后用其而不是stiff func对eigenvalue作用！
3. 先试试第一种



